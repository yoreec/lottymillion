<html>
<head>
    <title>Рекламная лотерея 🎰</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f0f2f5;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .balance-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .button {
            display: block;
            width: 100%;
            padding: 15px;
            background: #0088cc;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .button:active {
            transform: scale(0.98);
        }
        
        .lottery-info {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 15px;
        }
        
        .timer {
            color: #0088cc;
            font-weight: bold;
        }

  // Добавлены новые стили для рефералов

        .referral-card {
            background: linear-gradient(90deg, #ff6b6b, #ff9f43);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
        }
        .referral-code {
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎉 Заработай на лотерее!</h1>
            <p>Смотри рекламу ➡️ получай билеты ➡️ выигрывай деньги!</p>
        </div>
        
        <div class="balance-card">
            <h3>Твои билеты: <span id="tickets">0</span></h3>
            <p>Следующий розыгрыш через: <span class="timer" id="timer">00:00:00</span></p>
        </div>
        
        <button class="button" id="watchAd">📺 Смотреть рекламу (+1 билет)</button>
        
        <div class="lottery-info">
            <h2>🏆 Текущий джекпот: <span id="jackpot">100</span> RUB</h2>
            <p>Последний победитель: <span id="lastWinner">...</span></p>
        </div>
	<!-- Добавлен блок рефералов -->
        <div class="referral-card">
            <h3>👥 Приведи друга = +5 билетов!</h3>
            <p>Твоя ссылка: 
                <span class="referral-code" onclick="copyReferralLink()" 
                      id="referralLink">Загрузка...</span>
            </p>
            <p>Приглашено: <span id="referralCount">0</span> друзей</p>
        </div>
    </div>

    <script>
        // Инициализация WebApp Telegram
        const webApp = Telegram.WebApp;
        webApp.ready();
        
        // Состояние приложения
        let state = {
            tickets: localStorage.getItem('tickets') || 0,
            jackpot: 100,
            lastWinner: localStorage.getItem('lastWinner') || 'еще нет',
            nextDraw: localStorage.getItem('nextDraw') || Date.now() + 86400000
        };

        // Элементы интерфейса
        const ticketsEl = document.getElementById('tickets');
        const jackpotEl = document.getElementById('jackpot');
        const lastWinnerEl = document.getElementById('lastWinner');
        const timerEl = document.getElementById('timer');
        
        // Обновление интерфейса
        function updateUI() {
            ticketsEl.textContent = state.tickets;
            jackpotEl.textContent = state.jackpot;
            lastWinnerEl.textContent = state.lastWinner;
            localStorage.setItem('tickets', state.tickets);
            localStorage.setItem('nextDraw', state.nextDraw);
            localStorage.setItem('lastWinner', state.lastWinner);
        }

        // Таймер обратного отсчета
        function updateTimer() {
            const now = Date.now();
            const diff = state.nextDraw - now;
            
            if(diff <= 0) {
                conductLottery();
                return;
            }
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            timerEl.textContent = 
                `${String(hours).padStart(2, '0')}:` +
                `${String(minutes).padStart(2, '0')}:` +
                `${String(seconds).padStart(2, '0')}`;
        }

        // Проведение лотереи
        function conductLottery() {
            // В реальности здесь должно быть обращение к серверу
            const winner = Math.random() < 0.5 ? 'Вы!' : 'Другой игрок';
            
            state.lastWinner = winner;
            state.jackpot += 50;
            state.nextDraw = Date.now() + 86400000;
            
            if(winner === 'Вы!' && state.tickets > 0) {
                webApp.showPopup({
                    title: '🎉 Победа!',
                    message: `Вы выиграли ${state.jackpot} RUB!`,
                    buttons: [{ type: 'close' }]
                });
                state.jackpot = 100;
            }
            
            updateUI();
        }

        // Обработчик просмотра рекламы
        document.getElementById('watchAd').addEventListener('click', () => {
            webApp.showPopup({
                title: 'Реклама',
                message: 'Сейчас будет показана реклама...',
                buttons: [{ type: 'close' }]
            });
            
            // Имитация просмотра рекламы
            setTimeout(() => {
                state.tickets++;
                updateUI();
                webApp.showAlert('Спасибо! Вы получили 1 билет!');
            }, 3000);
        });

        // Запуск таймера
        setInterval(updateTimer, 1000);
        updateUI();
        updateTimer();

	 // Добавлена реферальная логика
        function generateReferralCode() {
            return Math.random().toString(36).substr(2, 8).toUpperCase();
        }

        function copyReferralLink() {
            const link = `https://t.me/${webApp.initDataUnsafe.user.username}?startapp=${state.referralCode}`;
            navigator.clipboard.writeText(link)
;
            webApp.showAlert('Ссылка скопирована! Отправь другу 🚀');
        }

        // Обновлен state
        let state = {
            ...previousState,
            referralCode: localStorage.getItem('referralCode') || generateReferralCode(),
            referralCount: localStorage.getItem('referralCount') || 0,
            referredBy: localStorage.getItem('referredBy') || null
        };

        // Проверка реферала при запуске
        if(webApp.initDataUnsafe.start_param) {
            const referrerCode = webApp.initDataUnsafe.start_param;
            if(!state.referredBy && referrerCode !== state.referralCode) {
                state.referredBy = referrerCode;
                webApp.showPopup({
                    title: '🎁 Бонус за друга!',
                    message: 'Ты получишь +1 билет когда посмотришь первую рекламу'
                });
            }
        }

        // Модифицирован обработчик рекламы
        document.getElementById('watchAd').addEventListener('click', () => {
            setTimeout(() => {
                state.tickets++;
                
                // Выдача бонуса за первое действие реферала
                if(state.referredBy && !localStorage.getItem('rewarded')) {
                    localStorage.setItem('rewarded', 'true');
                    giveReferralBonus(state.referredBy, 1);
                }
                
                // Выдача бонуса за активность реферала
                if(state.tickets % 5 === 0 && state.referredBy) {
                    giveReferralBonus(state.referredBy, 3);
                }
                
                updateUI();
            }, 3000);
        });

        // Новая функция для бонусов
        function giveReferralBonus(referralCode, amount) {
            // В реальности здесь запрос к серверу
            const referrer = findUserByCode(referralCode); 
            referrer.tickets += amount;
            webApp.showAlert(`💎 Твой друг получил ${amount} билетов за твою активность!`);
        }

        // Обновляем UI
        function updateUI() {
            ...previousUIUpdates...
            document.getElementById('referralLink').textContent = state.referralCode;
            document.getElementById('referralCount').textContent = state.referralCount;
            localStorage.setItem('referralCode', state.referralCode);
            localStorage.setItem('referralCount', state.referralCount);
        }
    </script>
</body>
</html>